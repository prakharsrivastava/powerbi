import org.apache.spark.sql.{SparkSession, DataFrame}
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types._

// Sample data
val data = Seq(
  ("suzan kapoor", Seq(("color", "black"), ("gift", "no"))),
  ("john doe", Seq(("color", "blue"), ("gift", "yes")))
)

// Create DataFrame with schema
val schema = StructType(Seq(
  StructField("lastname", StringType, nullable = false),
  StructField("demo", ArrayType(StructType(Seq(
    StructField("label", StringType, nullable = false),
    StructField("value", StringType, nullable = false)
  ))), nullable = false)
))

val spark = SparkSession.builder()
  .appName("Convert Demo Array to JSON Array")
  .master("local[*]")
  .getOrCreate()

import spark.implicits._

// Create DataFrame
val df = spark.createDataFrame(data).toDF("lastname", "demo")

// Display the original DataFrame
println("Original DataFrame:")
df.show(false)

// Define a UDF to convert array to JSON array format
val arrayToJsonUDF = udf((array: Seq[Row]) => {
  array.map { case Row(label: String, value: String) =>
    s"""{"label":"$label","value":"$value"}"""
  }
})

// Convert demo array column to JSON array format
val jsonDF = df.withColumn("demo_json", arrayToJsonUDF($"demo"))

// Display the transformed DataFrame
println("Transformed DataFrame:")
jsonDF.show(false)

// Stop SparkSession
spark.stop()
